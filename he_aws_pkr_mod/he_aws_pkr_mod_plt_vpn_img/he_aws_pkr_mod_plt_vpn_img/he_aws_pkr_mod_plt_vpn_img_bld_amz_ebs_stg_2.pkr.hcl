# Copyright (c) 2018 - 2020 Adam Horden <adam.horden@horden.engineering>

# ----------------------------------------------------------------------------------------
# Build:
# ----------------------------------------------------------------------------------------

build {

  # --------------------------------------------------------------------------------------
  # Sources:
  # --------------------------------------------------------------------------------------

  sources = [
    "source.amazon-ebssurrogate.he_aws_pkr_mod_plt_vpn_img_src_amz_ebs_stg_2",
  ]

  # --------------------------------------------------------------------------------------
  # Arguments:
  # --------------------------------------------------------------------------------------

  name = "he_aws_pkr_mod_plt_vpn_img_stg_2"

  # --------------------------------------------------------------------------------------
  # Provisioner:
  # --------------------------------------------------------------------------------------

  provisioner "shell" {

    # ------------------------------------------------------------------------------------
    # Only:
    # ------------------------------------------------------------------------------------

    only = [
      "amazon-ebssurrogate.he_aws_pkr_mod_plt_vpn_img_src_amz_ebs_stg_2",
    ]

    # ------------------------------------------------------------------------------------
    # Argument:
    # ------------------------------------------------------------------------------------

    #

    inline = [

      # ----------------------------------------------------------------------------------
      #
      # ----------------------------------------------------------------------------------

      #

      format(
        "printf '%s ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/100_%s",
        local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_ssh_un,
        local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_ssh_un,
      ),

      # ----------------------------------------------------------------------------------
      #
      # ----------------------------------------------------------------------------------

      #

      format(
        "chmod 0440 /etc/sudoers.d/100_%s",
        local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_ssh_un,
      ),

    ]

    # ------------------------------------------------------------------------------------
    # Arguments:
    # ------------------------------------------------------------------------------------

    execute_command = local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_pv_sh_exe_com

  }

  # --------------------------------------------------------------------------------------
  # Provisioner:
  # --------------------------------------------------------------------------------------

  provisioner "shell" {

    # ------------------------------------------------------------------------------------
    # Only:
    # ------------------------------------------------------------------------------------

    only = [
      "amazon-ebssurrogate.he_aws_pkr_mod_plt_vpn_img_src_amz_ebs_stg_2",
    ]

    # ------------------------------------------------------------------------------------
    # Argument:
    # ------------------------------------------------------------------------------------

    #

    script = format(
      "%s/%s/%s/%s/%s/%s",
      var.he_aws_pkr_mod_pth,
      "he_aws_pkr_mod",
      "he_aws_pkr_mod_plt_vpn_img",
      "he_aws_pkr_mod_plt_vpn_img",
      "he_aws_pkr_mod_plt_vpn_img_stg_2",
      "script_001_name.sh",
    )

    # ------------------------------------------------------------------------------------
    # Arguments:
    # ------------------------------------------------------------------------------------

    execute_command   = local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_pv_sh_exe_com
    expect_disconnect = "true"
    inline_shebang    = "/usr/bin/env bash"

  }

  # --------------------------------------------------------------------------------------
  # Provisioner:
  # --------------------------------------------------------------------------------------

  provisioner "shell" {

    # ------------------------------------------------------------------------------------
    # Only:
    # ------------------------------------------------------------------------------------

    only = [
      "amazon-ebssurrogate.he_aws_pkr_mod_plt_vpn_img_src_amz_ebs_stg_2",
    ]

    # ------------------------------------------------------------------------------------
    # Argument:
    # ------------------------------------------------------------------------------------

    #

    inline = [

      # ----------------------------------------------------------------------------------
      # Script:
      # ----------------------------------------------------------------------------------

      #

      format(
        "aws s3 cp %s %s",
        local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_pv_sh_s3_pth,
        "/tmp",
      ),

    ]

    # ------------------------------------------------------------------------------------
    # Arguments:
    # ------------------------------------------------------------------------------------

    execute_command = local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_pv_sh_exe_com

  }

  # --------------------------------------------------------------------------------------
  # Provisioner:
  # --------------------------------------------------------------------------------------

  provisioner "shell" {

    # ------------------------------------------------------------------------------------
    # Only:
    # ------------------------------------------------------------------------------------

    only = [
      "amazon-ebssurrogate.he_aws_pkr_mod_plt_vpn_img_src_amz_ebs_stg_2",
    ]

    # ------------------------------------------------------------------------------------
    # Argument:
    # ------------------------------------------------------------------------------------

    #

    inline = [

      # [REFACTOR]

      # ----------------------------------------------------------------------------------
      # Script:
      # ----------------------------------------------------------------------------------

      #

      format(
        "lsblk -f",
      ),

      format(
        "df -H",
      ),

      format(
        "cat /proc/mounts",
      ),

      format(
        "tar xzOf %s | dd status=progress of=%s bs=1M",
        "/tmp/he_aws_tf_app_usr_ah_plt_vpn_img_bld_stg_1_v_0_0_1_env_1.raw.tar.gz",
        "/dev/xvdb",
      ),

    ]

    # ------------------------------------------------------------------------------------
    # Arguments:
    # ------------------------------------------------------------------------------------

    # [REFACTOR]

    execute_command   = local.he_aws_pkr_mod_plt_vpn_img_bld_amz_ebs_stg_2_pv_sh_exe_com
    expect_disconnect = "true"
    inline_shebang    = "/usr/bin/env bash"

  }

}
